//
//  Clients.ts
//
//  Generated by Poll Castillo on 15/02/2023
//
import { getFilterEntityCount, getFilterEntityData } from "../../endpoints.js";
import { drawTagsIntoTables, inputObserver, CloseDialog, inputSelectTypeAudit, verifyUserType, averageTime } from "../../tools.js";
import { Config } from "../../Configs.js";
import { tableLayout } from "./Layout.js";
//import { exportAuditPdf } from "../../exportFiles/audit.js";
import { exportAuditV2Xls } from "../../exportFiles/auditv2.js";
const customerId = localStorage.getItem('customer_id');
let infoPage = {
    startDate: "",
    endDate: "",
    onPressed: false
};
export class Audits {
    constructor() {
        this.dialogContainer = document.getElementById('app-dialogs');
        this.entityDialogContainer = document.getElementById('entity-editor-container');
        this.datatableContainer = document.getElementById('datatable-container');
        /*private selectService(): void {
                
            const btnElement: InterfaceElement = document.getElementById('btn-select-service')
            //let offset = 0
    
            btnElement.addEventListener('click', async (): Promise<void> => {
                const service: InterfaceElement = document.getElementById('entity-service')
                const element: InterfaceElement = document.getElementById('entity-element')
                if(element.value != ''){
                    modalTable(0, "", service, element)
                }else{
                    alert("Cliente no ha sido seleccionado")
                }
            })
    
            async function modalTable(offset: any, search: any, service: any, element: any){
                const dialogContainer: InterfaceElement =document.getElementById('app-dialogs')
                let raw2 = JSON.stringify({
                    "filter": {
                        "conditions": [
                            {
                                "group": "OR",
                                "conditions": [
                                    {
                                        "property": "name",
                                        "operator": "contains",
                                        "value": `${search.toLowerCase()}`
                                    },
                                    {
                                        "property": "noOrder",
                                        "operator": "contains",
                                        "value": `${search.toLowerCase()}`
                                    },
                                    {
                                        "property": "supervisorUser",
                                        "operator": "contains",
                                        "value": `${search.toLowerCase()}`
                                    }
                                ]
                            },
                            {
                                "property": "business.id",
                                "operator": "=",
                                "value": `${businessId}`
                            },
                            {
                                "property": "customer.id",
                                "operator": "=",
                                "value": `${element.dataset.optionid}`
                            }
                        ],
                        
                    },
                    sort: "-createdDate",
                    limit: Config.modalRows,
                    offset: offset,
                    //fetchPlan: 'full',
                    
                })
                const dataModal = await getFilterEntityData("Routine", raw2)
                dialogContainer.style.display = 'block'
                dialogContainer.innerHTML = `
                    <div class="dialog_content" id="dialog-content2">
                        <div class="dialog">
                            <div class="dialog_container padding_8">
                                <div class="dialog_header">
                                    <h2>SELECCIONAR SERVICIO</h2>
                                </div>
    
                                <div class="dialog_message padding_8">
                                    <div class="datatable_tools">
                                        <input type="search"
                                        class="search_input"
                                        placeholder="Buscar"
                                        id="search-modal2">
                                        <button
                                            class="datatable_button add_user"
                                            id="btnSearchModal2">
                                            <i class="fa-solid fa-search"></i>
                                        </button>
                                    </div>
                                    <div class="dashboard_datatable">
                                        <table class="datatable_content margin_t_16">
                                        <thead>
                                            <tr>
                                            <th>Servicio</th>
                                            <th>Pedido</th>
                                            <th>Fecha</th>
                                            <th>Supervisor</th>
                                            <th></th>
                                            </tr>
                                        </thead>
                                        <tbody id="datatable-modal-body">
                                        </tbody>
                                        </table>
                                    </div>
                                    <br>
                                </div>
    
                                <div class="dialog_footer">
                                    <button class="btn btn_primary" id="prevModal2"><i class="fa-solid fa-arrow-left"></i></button>
                                    <button class="btn btn_primary" id="nextModal2"><i class="fa-solid fa-arrow-right"></i></button>
                                    <button class="btn btn_danger" id="cancel2">Cancelar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                `
                inputObserver()
                const datetableBody: InterfaceElement = document.getElementById('datatable-modal-body')
                if (dataModal.length === 0) {
                    let row: InterfaceElement = document.createElement('tr')
                    row.innerHTML = `
                        <td>No hay datos</td>
                        <td></td>
                        <td></td>
                        <td></td>
                        <td></td>
                    `
                    datetableBody.appendChild(row)
                }
                else {
                    for (let i = 0; i < dataModal.length; i++) {
                        let routine = dataModal[i]
                        //let supervisor = `${routine?.supervisorId?.firstName ?? ''} ${routine?.supervisorId?.lastName ?? ''}`
                        let row: InterfaceElement =
                            document.createElement('tr')
                        row.innerHTML += `
                            <td>${routine?.name ?? ''}</td>
                            <td>${routine?.noOrder ?? ''}</td>
                            <td>${routine?.creationDate ?? ''}</td>
                            <td>${routine?.supervisorUser ?? ''}</td>
                            <td class="entity_options">
                                <button class="button" id="edit-entity2" data-entityId="${routine.id}" data-entityName="${routine?.name ?? ''}">
                                    <i class="fa-solid fa-arrow-up-right-from-square"></i>
                                </button>
                            </td>
                        `
                        datetableBody.appendChild(row)
                        drawTagsIntoTables()
                    }
                }
                const txtSearch: InterfaceElement = document.getElementById('search-modal2')
                const btnSearchModal: InterfaceElement = document.getElementById('btnSearchModal2')
                const _selectCustomer: InterfaceElement = document.querySelectorAll('#edit-entity2')
                const _closeButton: InterfaceElement = document.getElementById('cancel2')
                const _dialog: InterfaceElement = document.getElementById('dialog-content2')
                const prevModalButton: InterfaceElement = document.getElementById('prevModal2')
                const nextModalButton: InterfaceElement = document.getElementById('nextModal2')
    
                txtSearch.value = search ?? ''
    
                _selectCustomer.forEach((edit: InterfaceElement) => {
                    const entityId = edit.dataset.entityid
                    const entityName = edit.dataset.entityname
                    edit.addEventListener('click', (): void => {
                        service.setAttribute('data-optionid', entityId)
                        service.setAttribute('value', `${entityName}`)
                        service.classList.add('input_filled')
                        new CloseDialog().x(_dialog)
                    })
                
                })
    
                btnSearchModal.onclick = () => {
                    console.log("clickea")
                    modalTable(0, txtSearch.value, service, element)
                }
    
                _closeButton.onclick = () => {
                    new CloseDialog().x(_dialog)
                }
    
                nextModalButton.onclick = () => {
                    offset = Config.modalRows + (offset)
                    modalTable(offset, search, service, element)
                }
    
                prevModalButton.onclick = () => {
                    offset = Config.modalRows - (offset)
                    modalTable(offset, search, service, element)
                }
            }
        }*/
    }
    async render(startDate, endDate) {
        infoPage.startDate = startDate;
        infoPage.endDate = endDate;
        this.datatableContainer.innerHTML = '';
        this.datatableContainer.innerHTML = tableLayout;
        const _inputElements = {
            divStats: document.getElementById('stats-customer'),
            divStatsUser: document.getElementById('stats-user'),
            entityUser: document.getElementById('entity-user-stats'),
            objetiveType: document.getElementById('entity-type'),
            entityElement: document.getElementById('entity-element'),
            //entityService: document.getElementById('entity-service'),
            filterStartDate: document.getElementById("start-date"),
            filterEndDate: document.getElementById("end-date"),
            //checkDate: document.getElementById("entity-check-date"),
            calculateButton: document.getElementById('calculate-entity')
        };
        this.load(_inputElements);
        this.selectElement();
        //this.selectService()
        this.generateReport(_inputElements);
    }
    load(_inputElements) {
        _inputElements.filterStartDate.value = infoPage.startDate;
        _inputElements.filterEndDate.value = infoPage.endDate;
        //_inputElements.checkDate.checked = true
        inputSelectTypeAudit('entity-type', 'GUARDIA', _inputElements.divStats, _inputElements.divStatsUser, _inputElements.entityElement /*, _inputElements.entityService*/);
    }
    generateReport(_inputElements) {
        _inputElements.calculateButton.addEventListener('click', async () => {
            if ((_inputElements.objetiveType.value == 'CLIENTE' && _inputElements.entityElement.value != "") || _inputElements.objetiveType.value == 'GUARDIA' || _inputElements.objetiveType.value == 'CONSOLA') {
                if (!infoPage.onPressed) {
                    infoPage.onPressed = true;
                    this.dialogContainer.style.display = 'block';
                    this.dialogContainer.innerHTML = `
                    <div class="dialog_content" id="dialog-content">
                        <div class="dialog">
                            <div class="dialog_container padding_8">
                                <div class="dialog_header">
                                    <h2 id="modal-title">DATOS DE ${_inputElements.objetiveType.value}</h2>
                                </div>

                                <div class="dialog_message padding_8">
                                    <div class="material_input">
                                        <input type="text" id="modal-username" class="input_filled" value="${_inputElements.entityElement.value}" readonly>
                                        <label modal-username"><i class="fa-solid fa-user"></i> Objetivo</label>
                                    </div>

                                    <div class="material_input">
                                        <input type="text" id="modal-calendar" class="input_filled" value="${_inputElements.filterStartDate.value} - ${_inputElements.filterEndDate.value}" readonly>
                                        <label modal-calendar"><i class="fa-solid fa-calendar"></i> Fecha</label>
                                    </div>

                                    <div class="material_input">
                                        <input type="text" id="modal-subtitle" class="input_filled" value="Espere un momento..." readonly>
                                        <label modal-subtitle"><i class="fa-solid fa-cloud-arrow-down"></i> Obteniendo datos</label>
                                    </div>

                                    <div class="input_detail" id="modal-message"></div>
                                </div>

                                <div class="dialog_footer" style="display:inline-flex">
                                    <button class="btn btn_primary" id="cancel">Cancelar</button>
                                    <button class="btn btn_primary" id="download" style="display:none;">Descargar</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    `;
                    inputObserver();
                    const titleModal = document.getElementById("modal-title");
                    const subtitleModal = document.getElementById("modal-subtitle");
                    const messageModal = document.getElementById("modal-message");
                    const _closeButton = document.getElementById('cancel');
                    const _dwnButton = document.getElementById('download');
                    _closeButton.onclick = () => {
                        infoPage.onPressed = false;
                        const _dialog = document.getElementById('dialog-content');
                        new CloseDialog().x(_dialog);
                    };
                    const conditions = {
                        objetive: _inputElements.objetiveType.value,
                        filterStartDate: _inputElements.filterStartDate.value,
                        filterEndDate: _inputElements.filterEndDate.value,
                        operator: '',
                        property: '',
                        value: _inputElements.entityElement.dataset.optionid ?? '',
                        name: _inputElements.entityElement.value ?? '',
                        countCumplido: 0,
                        countNoCumplido: 0,
                        registers: [],
                        registersNot: [],
                        registersLibre: [],
                        respConsole: 0,
                        average: '',
                        service: '',
                        countCumplido2: 0,
                        countNoCumplido2: 0,
                        property2: '',
                        value2: '',
                        registers2: [],
                        registersNot2: [],
                        respConsole2: 0,
                        average2: '',
                        allRoutines: [],
                        allUsersRoutines: []
                    };
                    let status = [];
                    if (_inputElements.objetiveType.value == 'GUARDIA') {
                        //conditions.property = 'user.id'
                        conditions.property = 'routine.name';
                        conditions.operator = '<>';
                        status = ["Cumplido", "No cumplido", "Libre"];
                    }
                    else if (_inputElements.objetiveType.value == 'CONSOLA') {
                        //conditions.property = 'consoleUserId.id'
                        conditions.property = 'routine.name';
                        conditions.operator = '<>';
                        status = ["No cumplido"];
                    }
                    else {
                        conditions.property = 'customer.id';
                        conditions.operator = '=';
                        status = ["Cumplido", "No cumplido"];
                    }
                    const rawToModify = (offset, property, operator, value, status) => {
                        const rawToCount = JSON.stringify({
                            "filter": {
                                "conditions": [
                                    {
                                        "property": `customer.id`,
                                        "operator": "=",
                                        "value": `${customerId}`
                                    },
                                    {
                                        "property": `${property}`,
                                        "operator": `${operator}`,
                                        "value": `${value}`
                                    },
                                    {
                                        "property": "routineState.name",
                                        "operator": `=`,
                                        "value": `${status}`
                                    },
                                    {
                                        "property": "creationDate",
                                        "operator": `>=`,
                                        "value": `${conditions.filterStartDate}`
                                    },
                                    {
                                        "property": "creationDate",
                                        "operator": `<=`,
                                        "value": `${conditions.filterEndDate}`
                                    }
                                ],
                            },
                            sort: "-createdDate",
                            limit: Config.limitExport,
                            offset: offset,
                            fetchPlan: 'full',
                        });
                        return rawToCount;
                    };
                    for (let i = 0; i < status.length; i++) {
                        const rawToCount = rawToModify(0, conditions.property, conditions.operator, conditions.value, status[i]);
                        if (status[i] == "Cumplido") {
                            conditions.countCumplido = await getFilterEntityCount("RoutineRegister", rawToCount);
                        }
                        else if (status[i] == "No cumplido") {
                            conditions.countNoCumplido = await getFilterEntityCount("RoutineRegister", rawToCount);
                        }
                        else if (status[i] == "Libre") {
                            conditions.countLibre = await getFilterEntityCount("RoutineRegister", rawToCount);
                        }
                    }
                    if (conditions.countCumplido === undefined || conditions.countNoCumplido === undefined || conditions.countLibre === undefined) {
                        infoPage.onPressed = false;
                        const _dialog = document.getElementById('dialog-content');
                        new CloseDialog().x(_dialog);
                        alert("Ocurrió un error al exportar");
                    }
                    else if (conditions.countCumplido === 0 && conditions.countNoCumplido === 0 && conditions.countLibre === 0) {
                        infoPage.onPressed = false;
                        const _dialog = document.getElementById('dialog-content');
                        new CloseDialog().x(_dialog);
                        alert("No hay ningún registro");
                    }
                    else {
                        const totalRegisters = conditions.countCumplido + conditions.countNoCumplido + conditions.countLibre;
                        subtitleModal.value = `0 / ${totalRegisters}`;
                        const pages = Math.ceil(totalRegisters / Config.limitExport);
                        for (let i = 0; i < status.length; i++) {
                            let array = [];
                            let offset = 0;
                            if (status[i] == "Cumplido") {
                                for (let x = 0; x < pages; x++) {
                                    if (infoPage.onPressed) {
                                        const rawToCount = rawToModify(offset, conditions.property, conditions.operator, conditions.value, status[i]);
                                        array[x] = await getFilterEntityData("RoutineRegister", rawToCount); //await getEvents();
                                        for (let y = 0; y < array[x].length; y++) {
                                            conditions.registers.push(array[x][y]);
                                            const exisRoutine = conditions.allRoutines.some(data => data.id === array[x][y]['routine']['id']);
                                            if (!exisRoutine) {
                                                conditions.allRoutines.push(array[x][y]['routine']);
                                            }
                                        }
                                        subtitleModal.value = `${conditions.registers.length} / ${totalRegisters}`;
                                        offset = Config.limitExport + (offset);
                                    }
                                }
                            }
                            else if (status[i] == "No cumplido") {
                                for (let x = 0; x < pages; x++) {
                                    if (infoPage.onPressed) {
                                        const rawToCount = rawToModify(offset, conditions.property, conditions.operator, conditions.value, status[i]);
                                        array[x] = await getFilterEntityData("RoutineRegister", rawToCount); //await getEvents();
                                        for (let y = 0; y < array[x].length; y++) {
                                            conditions.registersNot.push(array[x][y]);
                                            const exisRoutine = conditions.allRoutines.some(data => data.id === array[x][y]['routine']['id']);
                                            if (!exisRoutine) {
                                                conditions.allRoutines.push(array[x][y]['routine']);
                                            }
                                        }
                                        subtitleModal.value = `${conditions.registers.length + conditions.registersNot.length} / ${totalRegisters}`;
                                        offset = Config.limitExport + (offset);
                                    }
                                }
                            }else if (status[i] == "Libre") {
                                for (let x = 0; x < pages; x++) {
                                    if (infoPage.onPressed) {
                                        const rawToCount = rawToModify(offset, conditions.property, conditions.operator, conditions.value, status[i]);
                                        array[x] = await getFilterEntityData("RoutineRegister", rawToCount); //await getEvents();
                                        for (let y = 0; y < array[x].length; y++) {
                                            conditions.registersLibre.push(array[x][y]);
                                            const exisRoutine = conditions.allRoutines.some(data => data.id === array[x][y]['routine']['id']);
                                            if (!exisRoutine) {
                                                conditions.allRoutines.push(array[x][y]['routine']);
                                            }
                                        }
                                        subtitleModal.value = `${conditions.registers.length + conditions.registersNot.length + conditions.registersLibre.length} / ${totalRegisters}`;
                                        offset = Config.limitExport + (offset);
                                    }
                                }
                            }
                        }
                        
                        //NO CUMPLIDAS PERO RESPONDIDAS
                        const responseConsole = [];
                        for (let i = 0; i < conditions.registersNot.length; i++) {
                            let observation = conditions.registersNot[i]["observation"] ?? "";
                            if (observation != "") {
                                if (conditions.registersNot[i]["consoleDate"] != undefined) {
                                    const creationDateTime = new Date(`${conditions.registersNot[i]["creationDate"]}T${conditions.registersNot[i]["creationTime"]}`);
                                    const consoleDateTime = new Date(`${conditions.registersNot[i]["consoleDate"]}T${conditions.registersNot[i]["consoleTime"]}`);
                                    const avg = consoleDateTime.getTime() - creationDateTime.getTime();
                                    //console.log(consoleDateTime+" - "+creationDateTime)
                                    //console.log(msToHHMMSS(avg))
                                    responseConsole.push(avg);
                                }
                            }
                        }
                        if (_inputElements.objetiveType.value == 'GUARDIA') {
                            const averageDate = averageTime(responseConsole);
                            conditions.respConsole = responseConsole.length;
                            conditions.average = averageDate;
                            //OBTENIENDO USUARIOS DE RUTINAS
                            subtitleModal.value = "Obteniendo guardias";
                            for (let i = 0; i < conditions.allRoutines.length; i++) {
                                const routine = conditions.allRoutines[i];
                                let offset = 0;
                                let array = [];
                                const rawModify = (routineId, offset) => {
                                    return JSON.stringify({
                                        "filter": {
                                            "conditions": [
                                                {
                                                    "property": `customer.id`,
                                                    "operator": "=",
                                                    "value": `${customerId}`
                                                },
                                                {
                                                    "property": `routine.id`,
                                                    "operator": `=`,
                                                    "value": `${routineId}`
                                                }
                                            ],
                                        },
                                        sort: "-createdDate",
                                        limit: Config.limitExport,
                                        offset: offset,
                                        fetchPlan: 'full'
                                    });
                                }
                                let countUsers = await getFilterEntityCount("RoutineUser", rawModify(routine.id, offset));
                                subtitleModal.value = `0 / ${countUsers}`;
                                const pages = Math.ceil(countUsers / Config.limitExport);
                                for (let x = 0; x < pages; x++) {
                                    if (infoPage.onPressed) {
                                        const rawToGuard = rawModify(routine.id, offset);
                                        array[x] = await getFilterEntityData("RoutineUser", rawToGuard);
                                        for (let y = 0; y < array[x].length; y++) {
                                            const existUserRoutine = conditions.allUsersRoutines.some(item => 
                                                item['user']['id'] === array[x][y]['user']['id'] && item['routine']['id'] === array[x][y]['routine']['id']);;
                                            if (!existUserRoutine) {
                                                conditions.allUsersRoutines.push(array[x][y]);
                                            }
                                        }
                                        subtitleModal.value = `${conditions.allUsersRoutines.length} / ${countUsers}`;
                                        offset = Config.limitExport + (offset);
                                    }
                                }
                            }
                            subtitleModal.value = `Cálculo completado, generando archivo...`;
                            /*messageModal.innerHTML = `
                                <p>Marcados: ${conditions.countCumplido}</p>
                                <p>No marcados: ${conditions.registersNot.length}</p>
                                <div style="padding-left: 20px;">
                                    <ul>
                                        <li>Respondidas por consola: ${responseConsole.length}</li>
                                        <li>Tiempo promedio: ${averageDate}</li>
                                    </ul>
                                </div>
                            `
                            _dwnButton.style.display = 'flex'*/
                        }
                        else if (_inputElements.objetiveType.value == 'CONSOLA') {
                            const averageDate = averageTime(responseConsole);
                            conditions.respConsole = responseConsole.length;
                            conditions.average = averageDate;
                            subtitleModal.value = `Cálculo completado, generando PDF...`;
                            /*messageModal.innerHTML = `
                                <div style="padding-left: 20px;">
                                    <ul>
                                        <li>Respondidas por consola: ${responseConsole.length}</li>
                                        <li>Tiempo promedio: ${averageDate}</li>
                                    </ul>
                                </div>
                            `
                            _dwnButton.style.display = 'flex'*/
                        }
                        else {
                            //if(_inputElements.entityService.value == ''){
                            subtitleModal.value = `Cálculo completado, generando PDF...`;
                            /*messageModal.innerHTML = `
                                <p>Marcados: ${conditions.countCumplido}</p>
                                <p>No marcados: ${conditions.countNoCumplido}</p>
                            `
                            _dwnButton.style.display = 'flex'*/
                            //}else{
                            /*conditions.property2 = 'routine.id'
                            conditions.value2 = _inputElements.entityService.dataset.optionid
                            for(let i = 0; i < status.length; i++){
                                const rawToCount = rawToModify(0, conditions.property2, conditions.value2, status[i])
                                if(status[i] == "Cumplido"){
                                    conditions.countCumplido2 = await getFilterEntityCount("RoutineRegister", rawToCount)
                                }else{
                                    conditions.countNoCumplido2 = await getFilterEntityCount("RoutineRegister", rawToCount)
                                }
                            }
                            const totalRegisters2 = conditions.countCumplido2 + conditions.countNoCumplido2
                            subtitleModal.value = `0 / ${totalRegisters2}`;
                            const pages2 = Math.ceil(totalRegisters2 / Config.limitExport);
                            for(let i = 0; i < status.length; i++){
                                let array = [];
                                let offset = 0;
                                if(status[i] == "Cumplido"){
                                    for(let x = 0; x < pages2; x++){
                                        if(infoPage.onPressed){
                                            const rawToCount = rawToModify(offset, conditions.property2, conditions.value2, status[i])
                                            array[x] = await getFilterEntityData("RoutineRegister", rawToCount) //await getEvents();
                                            for(let y=0; y<array[x].length; y++){
                                                conditions.registers2.push(array[x][y]);
                                            }
                                            subtitleModal.value = `${conditions.registers2.length} / ${totalRegisters2}`;
                                            offset = Config.limitExport + (offset);
                                        }
                                    }
                                }else{
                                    for(let x = 0; x < pages2; x++){
                                        if(infoPage.onPressed){
                                            const rawToCount = rawToModify(offset, conditions.property2, conditions.value2, status[i])
                                            array[x] = await getFilterEntityData("RoutineRegister", rawToCount) //await getEvents();
                                            for(let y=0; y<array[x].length; y++){
                                                conditions.registersNot2.push(array[x][y]);
                                            }
                                            subtitleModal.value = `${conditions.registers2.length + conditions.registersNot2.length} / ${totalRegisters2}`;
                                            offset = Config.limitExport + (offset);
                                        }
                                    }
                                }
                            }

                            const responseConsole2: number[] = []
                            for(let i=0; i<conditions.registersNot2.length; i++){
                                if(conditions.registersNot2[i]["observation"] != undefined){
                                    if(conditions.registersNot2[i]["consoleDate"] != undefined){
                                        const creationDateTime = new Date(`${conditions.registersNot2[i]["creationDate"]}T${conditions.registersNot2[i]["creationTime"]}`)
                                        const consoleDateTime = new Date(`${conditions.registersNot2[i]["consoleDate"]}T${conditions.registersNot2[i]["consoleTime"]}`)
                                        const avg = consoleDateTime.getTime() - creationDateTime.getTime()
                                        //console.log(consoleDateTime+" - "+creationDateTime)
                                        //console.log(msToHHMMSS(avg))
                                        responseConsole2.push(avg)
                                    }
                                }
                            }

                            const averageDate2 = averageTime(responseConsole2)
                            conditions.service = _inputElements.entityService.value
                            conditions.respConsole2 = responseConsole2.length
                            conditions.average2 = averageDate2
                            subtitleModal.value = `Cálculo completado`
                            messageModal.innerHTML = `
                                <p>Marcados: ${conditions.countCumplido}</p>
                                <p>No marcados: ${conditions.countNoCumplido}</p>
                                <br>
                                <h4>Servicio seleccionado:</h4>
                                <p>${_inputElements.entityService.value}</p>
                                <br>
                                <p>Marcados: ${conditions.countCumplido2}</p>
                                <p>No marcados: ${conditions.registersNot2.length}</p>
                                <div style="padding-left: 20px;">
                                    <ul>
                                        <li>Respondidas por consola: ${responseConsole2.length}</li>
                                        <li>Tiempo promedio: ${averageDate2}</li>
                                    </ul>
                                </div>
                            `
                            _dwnButton.style.display = 'flex'*/
                            //}   
                        }
                        //if (_inputElements.entityUser.checked && (_inputElements.objetiveType.value == 'GUARDIA' || _inputElements.objetiveType.value == 'CONSOLA')) {
                        //    await exportAuditV2Xls(conditions);
                        //}
                        //else {
                            //await exportAuditPdf(conditions);
                        //}
                        await exportAuditV2Xls(conditions);
                        infoPage.onPressed = false;
                        const _dialog = document.getElementById('dialog-content');
                        new CloseDialog().x(_dialog);
                        /*_dwnButton.onclick = async () => {
                            await exportAuditPdf(conditions)
                        };*/
                    }
                }
            }
            else {
                alert('Seleccione un elemento');
            }
        });
    }
    selectElement() {
        const btnElement = document.getElementById('btn-select-element');
        //let offset = 0
        btnElement.addEventListener('click', async () => {
            const element = document.getElementById('entity-element');
            modalTable(0, "", element);
        });
        async function modalTable(offset, search, element) {
            const dialogContainer = document.getElementById('app-dialogs');
            const objetiveType = document.getElementById('entity-type');
            const options = {
                table: '',
                header: [],
                order: '',
                raw: [],
                conditions: []
            };
            if (objetiveType.value == 'GUARDIA' || objetiveType.value == 'CONSOLA') {
                options.table = 'User';
                options.header = ['Usuario', 'Nombre', 'Tipo'];
                options.order = '+username';
                options.raw = [
                    {
                        "property": "userType",
                        "operator": "=",
                        "value": `GUARD`
                    },
                    {
                        "property": "isSuper",
                        "operator": "=",
                        "value": `${false}`
                    }
                ];
                options.conditions = [
                    {
                        "property": "firstName",
                        "operator": "contains",
                        "value": `${search.toLowerCase()}`
                    },
                    {
                        "property": "lastName",
                        "operator": "contains",
                        "value": `${search.toLowerCase()}`
                    },
                    {
                        "property": "secondLastName",
                        "operator": "contains",
                        "value": `${search.toLowerCase()}`
                    },
                    {
                        "property": "username",
                        "operator": "contains",
                        "value": `${search.toLowerCase()}`
                    }
                ];
                if (objetiveType.value == 'CONSOLA') {
                    options.raw = [
                        {
                            "property": "isSuper",
                            "operator": "=",
                            "value": `${true}`
                        }
                    ];
                }
            }
            else {
                options.table = 'Customer';
                options.header = ['Nombre', 'RUC', ''];
                options.order = '+name';
                options.raw = [];
                options.conditions = [
                    {
                        "property": "name",
                        "operator": "contains",
                        "value": `${search.toLowerCase()}`
                    },
                    {
                        "property": "ruc",
                        "operator": "contains",
                        "value": `${search.toLowerCase()}`
                    }
                ];
            }
            const raw = JSON.stringify({
                "filter": {
                    "conditions": [
                        {
                            "group": "OR",
                            "conditions": options.conditions
                        },
                        {
                            "property": "business.id",
                            "operator": "=",
                            "value": `${businessId}`
                        },
                        ...options.raw
                    ],
                },
                sort: options.order,
                limit: Config.modalRows,
                offset: offset,
                //fetchPlan: 'full',
            });
            const dataModal = await getFilterEntityData(options.table, raw);
            dialogContainer.style.display = 'block';
            dialogContainer.innerHTML = `
                <div class="dialog_content" id="dialog-content">
                    <div class="dialog">
                        <div class="dialog_container padding_8">
                            <div class="dialog_header">
                                <h2>SELECCIONAR ${objetiveType.value}</h2>
                            </div>

                            <div class="dialog_message padding_8">
                                <div class="datatable_tools">
                                    <input type="search"
                                    class="search_input"
                                    placeholder="Buscar"
                                    id="search-modal">
                                    <button
                                        class="datatable_button add_user"
                                        id="btnSearchModal">
                                        <i class="fa-solid fa-search"></i>
                                    </button>
                                </div>
                                <div class="dashboard_datatable">
                                    <table class="datatable_content margin_t_16">
                                    <thead>
                                        <tr>
                                        <th>${options.header[0]}</th>
                                        <th>${options.header[1]}</th>
                                        <th>${options.header[2]}</th>
                                        <th></th>
                                        </tr>
                                    </thead>
                                    <tbody id="datatable-modal-body">
                                    </tbody>
                                    </table>
                                </div>
                                <br>
                            </div>

                            <div class="dialog_footer">
                                <button class="btn btn_primary" id="prevModal"><i class="fa-solid fa-arrow-left"></i></button>
                                <button class="btn btn_primary" id="nextModal"><i class="fa-solid fa-arrow-right"></i></button>
                                <button class="btn btn_danger" id="cancel">Cancelar</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            inputObserver();
            const datetableBody = document.getElementById('datatable-modal-body');
            if (dataModal.length === 0) {
                let row = document.createElement('tr');
                row.innerHTML = `
                    <td>No hay datos</td>
                    <td></td>
                    <td></td>
                    <td></td>
                `;
                datetableBody.appendChild(row);
            }
            else {
                for (let i = 0; i < dataModal.length; i++) {
                    let register = dataModal[i];
                    let row = document.createElement('tr');
                    const nameUser = `${register?.firstName ?? ''} ${register?.lastName ?? ''} ${register?.secondLastName ?? ''}`;
                    row.innerHTML += `
                        <td>${options.table == 'User' ? register?.username ?? '' : register?.name ?? ''}</td>
                        <td>${options.table == 'User' ? nameUser : register?.ruc ?? ''}</td>
                        <td>${options.table == 'User' ? verifyUserType(register?.userType ?? '') : ''}</td>
                        <td class="entity_options">
                            <button class="button" id="edit-entity" data-entityId="${register.id}" data-entityName="${options.table == 'User' ? register?.username ?? '' : register?.name ?? ''}">
                                <i class="fa-solid fa-arrow-up-right-from-square"></i>
                            </button>
                        </td>
                    `;
                    datetableBody.appendChild(row);
                    drawTagsIntoTables();
                }
            }
            const txtSearch = document.getElementById('search-modal');
            const btnSearchModal = document.getElementById('btnSearchModal');
            const _selectCustomer = document.querySelectorAll('#edit-entity');
            const _closeButton = document.getElementById('cancel');
            const _dialog = document.getElementById('dialog-content');
            const prevModalButton = document.getElementById('prevModal');
            const nextModalButton = document.getElementById('nextModal');
            txtSearch.value = search ?? '';
            _selectCustomer.forEach((edit) => {
                const entityId = edit.dataset.entityid;
                const entityName = edit.dataset.entityname;
                edit.addEventListener('click', () => {
                    element.setAttribute('data-optionid', entityId);
                    element.setAttribute('value', `${entityName}`);
                    element.classList.add('input_filled');
                    new CloseDialog().x(_dialog);
                });
            });
            btnSearchModal.onclick = () => {
                modalTable(0, txtSearch.value, element);
            };
            _closeButton.onclick = () => {
                new CloseDialog().x(_dialog);
            };
            nextModalButton.onclick = () => {
                offset = Config.modalRows + (offset);
                modalTable(offset, search, element);
            };
            prevModalButton.onclick = () => {
                offset = Config.modalRows - (offset);
                modalTable(offset, search, element);
            };
        }
    }
}
