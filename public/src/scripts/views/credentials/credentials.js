//
//  Clients.ts
//
//  Generated by Poll Castillo on 15/02/2023
//
import { getFilterEntityCount, getFilterEntityData } from "../../endpoints.js";
import { drawTagsIntoTables, inputObserver, CloseDialog  } from "../../tools.js";
import { Config } from "../../Configs.js";
import { tableLayout } from "./Layout.js";
import { exportCredentialsXls } from "../../exportFiles/credentials.js";

let infoPage = {
    onPressed: false
};
export class CredentialsView {
    constructor() {
        this.dialogContainer = document.getElementById('app-dialogs');
        this.entityDialogContainer = document.getElementById('entity-editor-container');
        this.datatableContainer = document.getElementById('datatable-container');
    }
    async render() {
        this.datatableContainer.innerHTML = '';
        this.datatableContainer.innerHTML = tableLayout;
        const _inputElements = {
            checkCustomer: document.getElementById("entity-cal-customer"),
            checkUser: document.getElementById("entity-cal-user"),
            calculateButton: document.getElementById('calculate-entity')
        };
        this.load(_inputElements);
        this.generateReport(_inputElements);
    }
    load(_inputElements) {
        //_inputElements.checkDate.checked = true
    }
    generateReport(_inputElements) {
        _inputElements.calculateButton.addEventListener('click', async () => {
            if (!infoPage.onPressed) {
                infoPage.onPressed = true;
                this.dialogContainer.style.display = 'block';
                this.dialogContainer.innerHTML = `
                <div class="dialog_content" id="dialog-content">
                    <div class="dialog">
                        <div class="dialog_container padding_8">
                            <div class="dialog_header">
                                <h2 id="modal-title">DATOS DE LICENCIAS</h2>
                            </div>

                            <div class="dialog_message padding_8">

                                <div class="material_input">
                                    <input type="text" id="modal-subtitle" class="input_filled" value="Espere un momento..." readonly>
                                    <label modal-subtitle"><i class="fa-solid fa-cloud-arrow-down"></i> Obteniendo datos</label>
                                </div>

                                <div class="input_detail" id="modal-message"></div>
                            </div>

                            <div class="dialog_footer" style="display:inline-flex">
                                <button class="btn btn_primary" id="cancel">Cancelar</button>
                                <button class="btn btn_primary" id="download" style="display:none;">Descargar</button>
                            </div>
                        </div>
                    </div>
                </div>
                `;
                inputObserver();
                const titleModal = document.getElementById("modal-title");
                const subtitleModal = document.getElementById("modal-subtitle");
                const messageModal = document.getElementById("modal-message");
                const _closeButton = document.getElementById('cancel');
                const _dwnButton = document.getElementById('download');
                _closeButton.onclick = () => {
                    infoPage.onPressed = false;
                    const _dialog = document.getElementById('dialog-content');
                    new CloseDialog().x(_dialog);
                };
                
                const rawToModify = (offset, property, operator, value, property1, operator1, value1, property2, operator2, value2, status) => {
                    const rawToCount = JSON.stringify({
                        "filter": {
                            "conditions": [
                                {
                                    "property": `${property}`,
                                    "operator": `${operator}`,
                                    "value": `${value}`
                                },
                                {
                                    "property": `${property1}`,
                                    "operator": `${operator1}`,
                                    "value": `${value1}`
                                },
                                {
                                    "property": `${property2}`,
                                    "operator": `${operator2}`,
                                    "value": `${value2}`
                                },
                                {
                                    "property": "state.name",
                                    "operator": `${status ? "<>" : "="}`,
                                    "value": `${status ? "" : "Enabled"}`
                                }
                            ],
                        },
                        sort: "-createdDate",
                        limit: Config.limitExport,
                        offset: offset,
                        //fetchPlan: 'full',
                    });
                    return rawToCount;
                };
                const businessId = Config.currentUser.business.id;
                const rawCustomer = rawToModify(0, "business.id", "=", businessId, "name", "<>", "", "name", "<>", "", _inputElements.checkCustomer.checked ? true : false);
                const nroCustomers = await getFilterEntityCount("Customer", rawCustomer);
                if (nroCustomers === undefined) {
                    infoPage.onPressed = false;
                    const _dialog = document.getElementById('dialog-content');
                    new CloseDialog().x(_dialog);
                    alert("Ocurrió un error al exportar");
                }
                else if (nroCustomers === 0) {
                    infoPage.onPressed = false;
                    const _dialog = document.getElementById('dialog-content');
                    new CloseDialog().x(_dialog);
                    alert("No hay ningún registro");
                }
                else {
                    const totalRegisters = nroCustomers;
                    subtitleModal.value = "Analizando empresas...";
                    messageModal.innerText = `0 / ${totalRegisters}`;
                    const pages = Math.ceil(totalRegisters / Config.limitExport);
                    const customers = [];
                    let array = [];
                    let offset = 0;
                    for (let x = 0; x < pages; x++) {
                        if (infoPage.onPressed) {
                            const rawToCount = rawToModify(offset, "business.id", "=", businessId, "name", "<>", "", "name", "<>", "", _inputElements.checkCustomer.checked ? true : false);
                            array[x] = await getFilterEntityData("Customer", rawToCount);
                            for (let y = 0; y < array[x].length; y++) {
                                customers.push(array[x][y]);
                            }
                            messageModal.innerText = `${customers.length} / ${totalRegisters}`;
                            offset = Config.limitExport + (offset);
                        }
                    }
                    let objFinal = {};
                    const users = [];
                    subtitleModal.value = "Analizando usuarios...";
                    for(let i=0; i < customers.length; i++){
                        const userTypes = [
                            {"type": "GUARD", "isSuper": false, "total": 0},
                            {"type": "CUSTOMER", "isSuper": false, "total": 0},
                            {"type": "EMPLOYEE", "isSuper": false, "total": 0},
                            {"type": "CONTRACTOR", "isSuper": false, "total": 0},
                            {"type": "GUARD", "isSuper": true, "total": 0},
                            {"type": "CUSTOMER", "isSuper": true, "total": 0}
                        ];
                        let customer = customers[i];
                        subtitleModal.value = `${customer?.name ?? ''}`;
                        messageModal.innerText = `${i + 1} / ${customers.length}`;
                        for(let j=0; j < userTypes.length; j++){
                            const userType = userTypes[j];
                            const rawToCount = rawToModify(0, "customer.id", "=", customer.id, "isSuper", "=", userType["isSuper"], "userType", "=", userType["type"], _inputElements.checkUser.checked ? true : false);
                            userType["total"] = await getFilterEntityCount("User", rawToCount);
                        }
                        objFinal = {
                            "Empresas": customer?.name ?? '',
                            "Guardias": userTypes[0]["total"],
                            "Clientes": userTypes[1]["total"],
                            "Empleados": userTypes[2]["total"],
                            "Contratistas": userTypes[3]["total"],
                            "Admin Guardia": userTypes[4]["total"],
                            "Admin Cliente": userTypes[5]["total"]
                        }
                        users.push(objFinal);
                    }
                    subtitleModal.value = `Cálculo final`;
                    const countFinal = {
                        guard: 0,
                        customer: 0,
                        employee: 0,
                        contractor: 0,
                        adminGuard: 0,
                        adminCustomer: 0
                    }
                    for(let i=0; i < users.length; i++){
                        messageModal.innerText = `${i + 1} / ${users.length}`;
                        countFinal.guard += users[i]["Guardias"];
                        countFinal.customer += users[i]["Clientes"];
                        countFinal.employee += users[i]["Empleados"];
                        countFinal.contractor += users[i]["Contratistas"];
                        countFinal.adminGuard += users[i]["Admin Guardia"];
                        countFinal.adminCustomer += users[i]["Admin Cliente"];
                
                        objFinal = {
                            "Empresas": "",
                            "Guardias": countFinal.guard,
                            "Clientes": countFinal.customer,
                            "Empleados": countFinal.employee,
                            "Contratistas": countFinal.contractor,
                            "Admin Guardia": countFinal.adminGuard,
                            "Admin Cliente": countFinal.adminCustomer
                        }
                    }
                    users.push(objFinal);
                    subtitleModal.value = `Cálculo completado, generando archivo...`;
                    await exportCredentialsXls(users);
                    infoPage.onPressed = false;
                    const _dialog = document.getElementById('dialog-content');
                    new CloseDialog().x(_dialog);
                    /*_dwnButton.onclick = async () => {
                        await exportAuditPdf(conditions)
                    };*/
                }
            }
        });
    }
}
